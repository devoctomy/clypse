@startuml SimpleWebAuthn-Sequence-Auth
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Sequence.puml

title SimpleWebAuthn Authentication & Decryption Sequence

participant "Web App" as App
participant "SimpleWebAuthn" as SWA
participant "Platform Detector" as PD
participant "WebAuthn Core" as WAC
participant "Browser WebAuthn" as Browser
participant "Platform Authenticator" as Auth
participant "PRF Handler" as PRF
participant "Encryption Engine" as Encrypt
participant "Web Crypto API" as Crypto

App -> SWA: authenticate({credentialId, encryptedData})
activate SWA

SWA -> SWA: validateInputs()
SWA -> PD: detectPlatform(userAgent)
PD --> SWA: platformConfig

SWA -> WAC: authenticate(credentialId, config)
activate WAC

WAC -> WAC: prepareAllowCredentials(credentialId)
WAC -> Browser: navigator.credentials.get()
Browser -> Auth: Prompt for biometric
Auth --> Browser: User authenticates  
Browser --> WAC: PublicKeyCredential

WAC -> PRF: handlePRFExtension(credential)
activate PRF

alt PRF Results Available
    PRF -> PRF: extractPRFResults()
    PRF --> WAC: PRF key material
    note right: Same key as during creation
else PRF Not Available
    PRF -> PRF: extractCredentialId()  
    PRF --> WAC: Credential ID material
    note right: Fallback method
end
deactivate PRF

WAC --> SWA: authentication + keyMaterial
deactivate WAC

opt Decryption Requested
    SWA -> Encrypt: decryptData(encryptedData, keyMaterial, salt)
    activate Encrypt
    
    Encrypt -> Crypto: deriveKey(HKDF, keyMaterial, salt)
    Crypto --> Encrypt: AES-GCM key
    note right: Same derivation as creation
    
    Encrypt -> Encrypt: base64Decode(encryptedData)
    Encrypt -> Encrypt: extractIVAndData()
    
    Encrypt -> Crypto: decrypt(AES-GCM, data, IV)
    Crypto --> Encrypt: plaintext bytes
    
    Encrypt -> Encrypt: bytesToString()
    Encrypt --> SWA: plaintext
    deactivate Encrypt
end

SWA -> SWA: buildDiagnostics()
SWA --> App: {success, authentication, decryption, diagnostics}
deactivate SWA

note over App: Application processes\nauthenticated user and\ndecrypted data

@enduml