var SimpleWebAuthn=function(e){"use strict";class t{static detectPlatform(){const e=navigator.userAgent,t=e.includes("Samsung")||e.includes("SM-");let r=6e4;t&&(r=3e5);let i="preferred";return t&&(i="required"),{isSamsung:t,isIOS:/iPad|iPhone|iPod/.test(e),isWindows:e.includes("Windows"),timeout:r,residentKey:i}}static logPlatformInfo(){const e=this.detectPlatform();console.log("=== Platform Detection ==="),console.log("User Agent:",navigator.userAgent),console.log("Platform:",navigator.platform),console.log("Samsung:",e.isSamsung),console.log("iOS:",e.isIOS),console.log("Windows:",e.isWindows),console.log("Timeout:",e.timeout,"ms"),console.log("Resident Key:",e.residentKey),console.log("========================")}}class r{static async encryptData(e,t,r){try{const r=await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:(new TextEncoder).encode("clypse-encryption-salt-v1"),info:(new TextEncoder).encode("clypse-encryption-key")},t,{name:"AES-GCM",length:256},!1,["encrypt"]),i=crypto.getRandomValues(new Uint8Array(12)),a=(new TextEncoder).encode(e),n=await crypto.subtle.encrypt({name:"AES-GCM",iv:i},r,a),o=new Uint8Array(i.length+n.byteLength);o.set(i,0),o.set(new Uint8Array(n),i.length);return{success:!0,encryptedData:btoa(String.fromCharCode(...o))}}catch(e){return{success:!1,error:`Encryption failed: ${e instanceof Error?e.message:"Unknown error"}`}}}static async decryptData(e,t,r){try{const r=await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:(new TextEncoder).encode("clypse-encryption-salt-v1"),info:(new TextEncoder).encode("clypse-encryption-key")},t,{name:"AES-GCM",length:256},!1,["decrypt"]),i=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),a=i.slice(0,12),n=i.slice(12),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:a},r,n);return{success:!0,plaintext:(new TextDecoder).decode(o)}}catch(e){return{success:!1,error:`Decryption failed: ${e instanceof Error?e.message:"Unknown error"}`}}}static async importKeyMaterial(e){return await crypto.subtle.importKey("raw",e,"HKDF",!1,["deriveKey"])}}class i{static async createCredential(e,t){try{const i=crypto.getRandomValues(new Uint8Array(32)),a=crypto.getRandomValues(new Uint8Array(32)),n={challenge:i,rp:{name:e.rpName,id:e.rpId||window.location.hostname},user:{id:a,name:e.userName,displayName:e.userDisplayName},pubKeyCredParams:[{alg:-7,type:"public-key"},{alg:-257,type:"public-key"}],timeout:e.timeout||t.timeout,authenticatorSelection:{authenticatorAttachment:e.authenticatorAttachment||"platform",userVerification:e.userVerification||"required",residentKey:e.residentKey||t.residentKey},extensions:{prf:{eval:{first:(new TextEncoder).encode(e.encryptionSalt||"webauthn-prf-salt-v1")}}}},o=await navigator.credentials.create({publicKey:n});if(!o)return{success:!1,error:"Failed to create credential - user may have cancelled"};const s={id:o.id,rawId:o.rawId,publicKey:btoa(String.fromCharCode(...new Uint8Array(o.rawId))),attestationObject:btoa(String.fromCharCode(...new Uint8Array(o.response.attestationObject)))},l=o.getClientExtensionResults().prf;let c,u;if(console.log("=== PRF Extension Analysis (Creation) ==="),console.log("PRF Result Object:",l),console.log("PRF Enabled:",l?.enabled),console.log("PRF Results Available:",!!l?.results),console.log("PRF First Result:",l?.results?.first?`${l.results.first.byteLength} bytes`:"none"),l&&l.enabled)if(l.results&&l.results.first)console.log("✅ Got PRF results directly from credential creation"),console.log("PRF Output Length:",l.results.first.byteLength,"bytes"),c=await r.importKeyMaterial(l.results.first),u="PRF";else{console.log("⚠️ PRF enabled but no results - attempting get() operation...");const i=await this.attemptPRFGet(o.rawId,e.encryptionSalt||"webauthn-prf-salt-v1",t);i.success?(c=i.keyMaterial,u="PRF"):(console.log("❌ PRF get() operation failed, falling back to credential ID:",i.error),c=await r.importKeyMaterial(o.rawId),u="CredentialID")}else console.log("❌ PRF not supported - using credential ID for key derivation"),console.log("Falling back to Credential ID method"),console.log("Credential ID Length:",o.rawId.byteLength,"bytes"),c=await r.importKeyMaterial(o.rawId),u="CredentialID";return{success:!0,credential:s,keyMaterial:c,keyDerivationMethod:u,prfResult:l}}catch(e){return{success:!1,error:`WebAuthn credential creation failed: ${e instanceof Error?e.message:"Unknown error"}`}}}static async authenticate(e,t){try{const i=crypto.getRandomValues(new Uint8Array(32)),a={challenge:i,allowCredentials:[{type:"public-key",id:Uint8Array.from(atob(e.credentialId),e=>e.charCodeAt(0))}],timeout:e.timeout||t.timeout,userVerification:e.userVerification||"required",extensions:{prf:{eval:{first:(new TextEncoder).encode(e.encryptionSalt||"webauthn-prf-salt-v1")}}}},n=await navigator.credentials.get({publicKey:a});if(!n)return{success:!1,error:"Authentication failed - user may have cancelled"};const o=n.response,s=n.id,l=btoa(String.fromCharCode(...new Uint8Array(o.signature))),c=btoa(String.fromCharCode(...new Uint8Array(o.authenticatorData))),u=n.getClientExtensionResults().prf;let d,p;return console.log("=== PRF Extension Analysis (Authentication) ==="),console.log("PRF Result Object:",u),console.log("PRF Enabled:",u?.enabled),console.log("PRF Results Available:",!!u?.results),console.log("PRF First Result:",u?.results?.first?`${u.results.first.byteLength} bytes`:"none"),u&&u.results&&u.results.first&&u.results.first.byteLength>0?(console.log("✅ PRF extension successful - using PRF key material"),console.log("PRF Output Length:",u.results.first.byteLength,"bytes"),d=await r.importKeyMaterial(u.results.first),p="PRF"):u&&u.enabled&&!u.results&&t.isSamsung?(console.log("⚠️ Samsung Pass PRF enabled but no results - this is expected behavior"),console.log("❌ PRF not available - falling back to credential ID derivation"),d=await r.importKeyMaterial(n.rawId),p="CredentialID"):(console.log("❌ PRF not available - falling back to credential ID derivation"),d=await r.importKeyMaterial(n.rawId),p="CredentialID"),{success:!0,credentialId:s,signature:l,authenticatorData:c,keyMaterial:d,keyDerivationMethod:p,prfResult:u}}catch(e){return{success:!1,error:`WebAuthn authentication failed: ${e instanceof Error?e.message:"Unknown error"}`}}}static async attemptPRFGet(e,t,i){try{const i={challenge:crypto.getRandomValues(new Uint8Array(32)),allowCredentials:[{type:"public-key",id:e}],userVerification:"required",extensions:{prf:{eval:{first:(new TextEncoder).encode(t)}}}},a=(await navigator.credentials.get({publicKey:i})).getClientExtensionResults().prf;if(console.log("=== PRF Extension Analysis (Get Operation) ==="),console.log("Get PRF Result:",a),console.log("Get PRF Results Available:",!!a?.results),a&&a.results&&a.results.first){console.log("✅ PRF results obtained from get() operation");return{success:!0,keyMaterial:await r.importKeyMaterial(a.results.first)}}return{success:!1,error:"PRF get() operation failed - no results"}}catch(e){return{success:!1,error:`PRF get() operation failed: ${e instanceof Error?e.message:"Unknown error"}`}}}}class a{static validateCreateOptions(e){if(!e.rpName||0===e.rpName.trim().length)return{valid:!1,error:"rpName is required and cannot be empty"};if(!e.userName||0===e.userName.trim().length)return{valid:!1,error:"userName is required and cannot be empty"};if(!e.userDisplayName||0===e.userDisplayName.trim().length)return{valid:!1,error:"userDisplayName is required and cannot be empty"};if(void 0!==e.rpId){if("string"!=typeof e.rpId||0===e.rpId.trim().length)return{valid:!1,error:"rpId must be a non-empty string if provided"};if(!/^[a-zA-Z0-9.-]+$/.test(e.rpId))return{valid:!1,error:"rpId must be a valid hostname format"}}if(void 0!==e.timeout&&("number"!=typeof e.timeout||e.timeout<=0||e.timeout>6e5))return{valid:!1,error:"timeout must be a positive number between 1 and 600000 (10 minutes)"};if(void 0!==e.userVerification){if(!["required","preferred","discouraged"].includes(e.userVerification))return{valid:!1,error:"userVerification must be 'required', 'preferred', or 'discouraged'"}}if(void 0!==e.authenticatorAttachment){if(!["platform","cross-platform"].includes(e.authenticatorAttachment))return{valid:!1,error:"authenticatorAttachment must be 'platform' or 'cross-platform'"}}if(void 0!==e.residentKey){if(!["required","preferred","discouraged"].includes(e.residentKey))return{valid:!1,error:"residentKey must be 'required', 'preferred', or 'discouraged'"}}return void 0===e.encryptionSalt||"string"==typeof e.encryptionSalt&&0!==e.encryptionSalt.trim().length?{valid:!0}:{valid:!1,error:"encryptionSalt must be a non-empty string if provided"}}static validateAuthOptions(e){if(!e.credentialId||0===e.credentialId.trim().length)return{valid:!1,error:"credentialId is required and cannot be empty"};try{atob(e.credentialId)}catch(e){return{valid:!1,error:"credentialId must be a valid base64 string"}}if(void 0!==e.timeout&&("number"!=typeof e.timeout||e.timeout<=0||e.timeout>6e5))return{valid:!1,error:"timeout must be a positive number between 1 and 600000 (10 minutes)"};if(void 0!==e.userVerification){if(!["required","preferred","discouraged"].includes(e.userVerification))return{valid:!1,error:"userVerification must be 'required', 'preferred', or 'discouraged'"}}if(void 0!==e.encryptedData){if("string"!=typeof e.encryptedData||0===e.encryptedData.trim().length)return{valid:!1,error:"encryptedData must be a non-empty string if provided"};try{atob(e.encryptedData)}catch(e){return{valid:!1,error:"encryptedData must be a valid base64 string"}}}return void 0===e.encryptionSalt||"string"==typeof e.encryptionSalt&&0!==e.encryptionSalt.trim().length?{valid:!0}:{valid:!1,error:"encryptionSalt must be a non-empty string if provided"}}}class n{static async createCredential(e){try{const n=a.validateCreateOptions(e);if(!n.valid)return{success:!1,error:n.error,diagnostics:this.getBasicDiagnostics()};const o=await this.checkWebAuthnSupport();if(!o.supported)return{success:!1,error:o.error,diagnostics:this.getBasicDiagnostics()};const s=t.detectPlatform(),l=await i.createCredential(e,s);if(!l.success)return{success:!1,error:l.error,diagnostics:this.buildDiagnostics(s,null,l.keyDerivationMethod||"unknown")};const c={success:!0,credential:l.credential,diagnostics:this.buildDiagnostics(s,l.prfResult||null,l.keyDerivationMethod)};if(e.plaintextToEncrypt){const t=await r.encryptData(e.plaintextToEncrypt,l.keyMaterial,e.encryptionSalt||"webauthn-prf-salt-v1");if(!t.success)return{success:!1,error:`Encryption failed: ${t.error}`,diagnostics:c.diagnostics};c.encryption={encryptedData:t.encryptedData,keyDerivationMethod:l.keyDerivationMethod}}return c}catch(e){return{success:!1,error:`Unexpected error: ${e instanceof Error?e.message:"Unknown error"}`,diagnostics:this.getBasicDiagnostics()}}}static async authenticate(e){try{const n=a.validateAuthOptions(e);if(!n.valid)return{success:!1,error:n.error,diagnostics:this.getBasicDiagnostics()};const o=await this.checkWebAuthnSupport();if(!o.supported)return{success:!1,error:o.error,diagnostics:this.getBasicDiagnostics()};const s=t.detectPlatform(),l=await i.authenticate(e,s);if(!l.success)return{success:!1,error:l.error,diagnostics:this.buildDiagnostics(s,null,l.keyDerivationMethod||"unknown")};const c={success:!0,authentication:{credentialId:l.credentialId,signature:l.signature,authenticatorData:l.authenticatorData,keyDerivationMethod:l.keyDerivationMethod},diagnostics:this.buildDiagnostics(s,l.prfResult||null,l.keyDerivationMethod)};if(e.encryptedData){const t=await r.decryptData(e.encryptedData,l.keyMaterial,e.encryptionSalt||"webauthn-prf-salt-v1");if(!t.success)return{success:!1,error:`Decryption failed: ${t.error}`,diagnostics:c.diagnostics};c.decryption={plaintext:t.plaintext,keyDerivationMethod:l.keyDerivationMethod}}return c}catch(e){return{success:!1,error:`Unexpected error: ${e instanceof Error?e.message:"Unknown error"}`,diagnostics:this.getBasicDiagnostics()}}}static async checkWebAuthnSupport(){if(console.log("=== WebAuthn Diagnostic Information ==="),console.log("User Agent:",navigator.userAgent),console.log("Platform:",navigator.platform),console.log("WebAuthn Support:",!!window.PublicKeyCredential),console.log("isUserVerifyingPlatformAuthenticatorAvailable:",!!window.PublicKeyCredential?.isUserVerifyingPlatformAuthenticatorAvailable),window.PublicKeyCredential&&window.PublicKeyCredential.getClientCapabilities)try{const e=await window.PublicKeyCredential.getClientCapabilities();console.log("Client Capabilities:",e)}catch(e){console.log("getClientCapabilities not supported or failed:",e)}else console.log("getClientCapabilities not available");if(!window.PublicKeyCredential||!window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable)return{supported:!1,error:"WebAuthn is not supported on this device"};try{const e=await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();if(console.log("Platform authenticator available:",e),!e)return{supported:!1,error:"Platform authenticator (Windows Hello/TouchID/etc.) is not available"}}catch(e){return{supported:!1,error:"Failed to check platform authenticator availability"}}return{supported:!0}}static buildDiagnostics(e,t,r){return{userAgent:navigator.userAgent,platform:navigator.platform,prfSupported:t?.enabled||!1,prfResultsAvailable:!!t?.results?.first,authenticatorType:this.getAuthenticatorType(r,e,t),keyDerivationMethod:r,credentialIdLength:0}}static getBasicDiagnostics(){return{userAgent:navigator.userAgent,platform:navigator.platform,prfSupported:!1,prfResultsAvailable:!1,authenticatorType:"Unknown",keyDerivationMethod:"unknown",credentialIdLength:0}}static getAuthenticatorType(e,t,r){return"PRF"===e?t.isSamsung?"Samsung Pass (PRF-enabled)":t.isIOS?"Face ID/Touch ID (PRF-enabled)":t.isWindows?"Windows Hello (PRF-enabled)":"Platform Authenticator (PRF-enabled)":t.isSamsung&&r?.enabled?"Samsung Pass (PRF detection issue)":t.isSamsung?"Samsung Pass (PIN fallback)":t.isIOS?"Face ID/Touch ID (fallback mode)":t.isWindows?"Windows Hello (fallback mode)":"Platform Authenticator (credential ID fallback)"}}return"undefined"!=typeof window&&(window.SimpleWebAuthn=n),e.SimpleWebAuthn=n,e}({});
//# sourceMappingURL=simple-webauthn.min.js.map
