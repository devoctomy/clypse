name: Tests

on:
  push:
  workflow_dispatch:

jobs:
  # codacy-analysis:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Run Codacy Analysis
  #       uses: codacy/codacy-analysis-cli-action@v4
  #       with:
  #         project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
  #         verbose: true


  unit-tests:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/dotnet:v1.55.0-noble
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Python (required for WASM build)
      run: |
        apt-get update
        apt-get install -y python3 python3-pip
        ln -sf /usr/bin/python3 /usr/bin/python
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Setup HTTPS development certificates
      run: |
        dotnet dev-certs https --clean
        dotnet dev-certs https --trust
        
    - name: Install .NET workloads
      run: dotnet workload install wasm-tools
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Run Unit Tests
      run: |
        echo "üß™ Running Unit Tests..."
        dotnet test \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --filter "FullyQualifiedName~UnitTests" \
          --logger trx \
          --results-directory ./TestResults/UnitTests \
          -p:CollectCoverage=true \
          -p:CoverletOutputFormat="json%2copencover" \
          -p:CoverletOutput="../coverage" \
          -p:MergeWith="../coverage.json" \
          clypse.sln
        echo "‚úÖ Unit Tests completed"
      
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: ./TestResults/UnitTests

    - name: Collect code coverage
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
      with:
        fail_ci_if_error: true
        files: ./TestResults/UnitTests/**/coverage.opencover.xml
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: true

  integration-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/dotnet:v1.55.0-noble
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Python (required for WASM build)
      run: |
        apt-get update
        apt-get install -y python3 python3-pip
        ln -sf /usr/bin/python3 /usr/bin/python
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Setup HTTPS development certificates
      run: |
        dotnet dev-certs https --clean
        dotnet dev-certs https --trust
        
    - name: Install .NET workloads
      run: dotnet workload install wasm-tools
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Run Integration Tests
      env:
        CLYPSE_INTTEST_AWS_BUCKETREGION: ${{ secrets.CLYPSE_INTTEST_AWS_BUCKETREGION }}
        CLYPSE_INTTEST_AWS_BUCKETNAME: ${{ secrets.CLYPSE_INTTEST_AWS_BUCKETNAME }}
        CLYPSE_INTTEST_AWS_ACCESSKEY: ${{ secrets.CLYPSE_INTTEST_AWS_ACCESSKEY }}
        CLYPSE_INTTEST_AWS_SECRETACCESSKEY: ${{ secrets.CLYPSE_INTTEST_AWS_SECRETACCESSKEY }}    
      run: |
        echo "üîó Running Integration Tests..."
        dotnet test clypse.core.IntTests --no-build --configuration Release --verbosity normal --logger trx --results-directory ./TestResults/IntegrationTests
        echo "‚úÖ Integration Tests completed"
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: ./TestResults/IntegrationTests

  ui-tests:
    needs: integration-tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/dotnet:v1.55.0-noble
    concurrency:
      group: ui-tests-sequential
      cancel-in-progress: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Python (required for WASM build)
      run: |
        apt-get update
        apt-get install -y python3 python3-pip
        ln -sf /usr/bin/python3 /usr/bin/python
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Setup HTTPS development certificates
      run: |
        dotnet dev-certs https --clean
        dotnet dev-certs https --trust
        
    - name: Install .NET workloads
      run: dotnet workload install wasm-tools
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Update appsettings.json
      run: |
        echo '${{ secrets.CLYPSE_UITESTS_PORTAL_APPSETTINGS }}' > clypse.portal/wwwroot/appsettings.json
      
    - name: Run UI Tests
      env:
        PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
        CLYPSE_UITESTS_USERNAME: ${{ secrets.CLYPSE_UITESTS_USERNAME }}
        CLYPSE_UITESTS_PASSWORD: ${{ secrets.CLYPSE_UITESTS_PASSWORD }}
      run: |
        echo "üñ•Ô∏è Running UI Tests..."
        dotnet test clypse.portal.UITests --no-build --configuration Release --verbosity normal --logger trx --results-directory ./TestResults/UITests
        echo "‚úÖ UI Tests completed"
      
    - name: Upload UI test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-results
        path: ./TestResults/UITests
