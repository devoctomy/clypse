name: Deploy to S3

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production

jobs:
  check-ci-status:
    runs-on: ubuntu-latest
    outputs:
      ci-status: ${{ steps.check.outputs.status }}
    steps:
    - name: Check CI workflow status
      id: check
      uses: actions/github-script@v7
      with:
        script: |
          const { data: workflows } = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'ci.yml',
            head_sha: context.sha,
            status: 'completed'
          });
          
          const ciRun = workflows.workflow_runs.find(run => run.head_sha === context.sha);
          
          if (!ciRun) {
            core.setFailed('No CI workflow run found for this commit');
            return;
          }
          
          if (ciRun.conclusion !== 'success') {
            core.setFailed(`CI workflow failed with status: ${ciRun.conclusion}`);
            return;
          }
          
          core.setOutput('status', 'success');
          console.log('CI workflow passed successfully');

  deploy:
    needs: check-ci-status
    runs-on: ubuntu-latest
    if: needs.check-ci-status.outputs.ci-status == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Install .NET workloads
      run: dotnet workload install wasm-tools
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Publish Blazor WebAssembly
      run: dotnet publish ./clypse.portal/clypse.portal.csproj -c Release -r browser-wasm --self-contained
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.CLYPSENETPORTAL_AWS_ACCESSKEY }}
        aws-secret-access-key: ${{ secrets.CLYPSENETPORTAL_AWS_SECRETACCESSKEY }}
        aws-region: ${{ secrets.CLYPSENETPORTAL_AWS_BUCKETREGION }}
        
    - name: Upload to S3
      run: |
        aws s3 sync ./clypse.portal/bin/Release/net8.0/publish/wwwroot/ s3://${{ secrets.CLYPSENETPORTAL_AWS_BUCKETNAME }}/ \
          --delete \
          --acl public-read \
          --cache-control "public, max-age=31536000" \
          --exclude "*.html" \
          --exclude "service-worker.js" \
          --exclude "service-worker-assets.js"
        
        # Upload HTML files and service worker with no-cache headers
        aws s3 sync ./clypse.portal/bin/Release/net8.0/publish/wwwroot/ s3://${{ secrets.CLYPSENETPORTAL_AWS_BUCKETNAME }}/ \
          --acl public-read \
          --cache-control "no-cache, no-store, must-revalidate" \
          --include "*.html" \
          --include "service-worker.js" \
          --include "service-worker-assets.js"
      
    - name: Invalidate CloudFront distribution
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ secrets.CLYPSENETPORTAL_AWS_CLOUDFRONTDISTRIBUTIONID }} \
          --paths "/*"
          
    - name: Deployment summary
      run: |
        echo "üöÄ Deployment completed successfully!"
        echo "üì¶ Published Blazor WebAssembly app to S3 bucket: ${{ secrets.CLYPSENETPORTAL_AWS_BUCKETNAME }}"
        echo "üåê CloudFront distribution invalidated: ${{ secrets.CLYPSENETPORTAL_AWS_CLOUDFRONTDISTRIBUTIONID }}"
        echo "‚úÖ Site should be available shortly at your CloudFront domain"
