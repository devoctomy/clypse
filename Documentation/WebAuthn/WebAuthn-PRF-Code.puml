@startuml WebAuthn_PRF_Code_View
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title WebAuthn PRF Encryption System - Code Level Flow

participant "UI Button" as UI
participant "webauthn-prf.js" as WA
participant "WebAuthn API" as API
participant "Crypto API" as Crypto
participant "Platform Auth" as Auth

note over UI, Auth: Encryption Flow

UI -> WA: encrypt(plaintextData)
activate WA

WA -> WA: Check for existing credential
alt Credential exists
    WA -> API: navigator.credentials.get({\n  publicKey: {\n    allowCredentials: [existingCred],\n    extensions: {\n      prf: { eval: { first: salt } }\n    }\n  }\n})
else No credential
    WA -> API: navigator.credentials.create({\n  publicKey: {\n    extensions: {\n      prf: { eval: { first: salt } }\n    }\n  }\n})
end

API -> Auth: Biometric prompt + PRF operation
Auth -> Auth: Generate PRF output from salt
Auth -> API: Credential + PRF result
API -> WA: { credential, extensions: { prf: { results: { first: prfBytes } } } }

WA -> Crypto: crypto.subtle.importKey(prfBytes, "HKDF")
Crypto -> WA: hkdfKey

WA -> Crypto: crypto.subtle.deriveKey(\n  { name: "HKDF", salt, info },\n  hkdfKey,\n  { name: "AES-GCM", length: 256 }\n)
Crypto -> WA: aesKey

WA -> Crypto: crypto.subtle.encrypt(\n  { name: "AES-GCM", iv },\n  aesKey,\n  plaintextData\n)
Crypto -> WA: encryptedData

WA -> WA: Store credential ID in localStorage
WA -> UI: { success: true, encryptedData, credentialId }

deactivate WA

note over UI, Auth: Decryption Flow (similar but decrypt operation)

@enduml