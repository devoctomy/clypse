@startuml Clypse_Secret_Access_Flow

title Clypse Portal - Secret Access Flow

actor User
participant "Clypse Portal\n(Blazor WASM)" as Portal
participant "Vault Manager" as VaultMgr
participant "AWS S3\n(User Bucket)" as S3
participant "Crypto Service" as Crypto

note over User, Crypto
**Precondition:** User has already unlocked vault
Vault Manager is initialized with derived key
end note

== View Secret ==
User -> Portal: Click to view/edit secret
note right of User
Secrets list shows:
• Secret ID
• Secret Name
• Secret Description
• Secret Tags
end note

Portal -> S3: Download secret file\n({vault-id}/secrets/{secret-id})
S3 --> Portal: Encrypted secret data

Portal -> VaultMgr: Decrypt secret\n(using vault key)
VaultMgr -> Crypto: Decrypt and decompress
Crypto --> VaultMgr: Decrypted secret data
VaultMgr --> Portal: Secret object\n(all fields populated)

Portal -> User: Display secret content\n(Name, Description, Tags, Fields)

== Edit Secret ==
User -> Portal: Modify secret\n(change name, description, tags, or fields)
Portal -> Portal: Secret.LastUpdatedAt = DateTime.UtcNow

User -> Portal: Click Save

Portal -> Portal: Vault.UpdateSecret(secret)\n(adds to PendingSecrets list)
Portal -> VaultMgr: SaveAsync(vault)

== Save Process ==
VaultMgr -> VaultMgr: Process PendingSecrets
VaultMgr -> VaultMgr: Find existing index entry\n(by secret ID)
VaultMgr -> VaultMgr: Remove old index entry
VaultMgr -> VaultMgr: Add updated index entry\n(ID, Name, Description, Tags)

VaultMgr -> Crypto: Compress and encrypt secret
Crypto --> VaultMgr: Encrypted secret data

VaultMgr -> S3: Upload secret file\n({vault-id}/secrets/{secret-id})
S3 --> VaultMgr: Upload complete

VaultMgr -> Crypto: Encrypt updated index
Crypto --> VaultMgr: Encrypted index

VaultMgr -> S3: Upload updated index\n({vault-id}/index.clypse)
S3 --> VaultMgr: Index saved

VaultMgr -> Portal: Save complete\n(SecretsUpdated: 1)
Portal -> User: ✅ Secret saved successfully

== Delete Secret ==
User -> Portal: Click delete secret
Portal -> User: Confirm deletion

User -> Portal: Confirm
Portal -> Portal: Vault.DeleteSecret(secretId)\n(adds to SecretsToDelete list)
Portal -> VaultMgr: SaveAsync(vault)

VaultMgr -> VaultMgr: Process SecretsToDelete
VaultMgr -> VaultMgr: Remove from index
VaultMgr -> S3: Delete secret file\n({vault-id}/secrets/{secret-id})
S3 --> VaultMgr: Deleted

VaultMgr -> Crypto: Encrypt updated index
Crypto --> VaultMgr: Encrypted index

VaultMgr -> S3: Upload updated index\n({vault-id}/index.clypse)
S3 --> VaultMgr: Index saved

VaultMgr -> Portal: Save complete\n(SecretsDeleted: 1)
Portal -> User: ✅ Secret deleted successfully

note right of VaultMgr
**Save Process:**
1. Process pending secrets (add/update)
   • Update index entries
   • Encrypt & upload each secret
2. Process secrets to delete
   • Remove from index
   • Delete from S3
3. Save updated index to S3
end note

@enduml
