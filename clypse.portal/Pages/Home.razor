@page "/"
@page "/home"
@using clypse.portal.Models
@using clypse.portal.Components
@using clypse.portal.Services
@using clypse.core.Cloud.Aws.S3
@using clypse.core.Vault
@using clypse.core.Cryptogtaphy
@using System.Security
@using Microsoft.JSInterop
@layout HomeLayout
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IVaultManagerFactoryService VaultManagerFactory
@inject IVaultStorageService VaultStorage
@inject AppSettings AppSettings
@inject AwsS3Config AwsS3Config
@inject AwsCognitoConfig CognitoConfig

<PageTitle>Clypse Portal - Home</PageTitle>

@if (currentPage == "vaults")
{
    <Vaults @ref="vaultsComponent" OnVaultUnlocked="HandleVaultUnlocked" />
}
else if (currentPage == "credentials")
{
    <Credentials CurrentVault="@currentVault" CurrentVaultKey="@currentVaultKey" VaultManager="@vaultManager" OnLockVault="HandleLockVault" />
}
else if (currentPage == "create-vault")
{
    <CreateVault OnCreateVault="HandleCreateVault" OnCancel="HandleCancelCreateVault" />
}

@code {

    private bool isLoggedIn = false;
    private string currentPage = "vaults"; // Default to vaults page
    private IVaultManager? vaultManager = null;
    private Components.Vaults? vaultsComponent;
    private VaultMetadata? currentVault = null;
    private string? currentVaultKey = null;

    [CascadingParameter] public Layout.HomeLayout? Layout { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize Cognito with configuration
            await JSRuntime.InvokeVoidAsync("eval", $@"
                window.cognitoConfig = {{
                    userPoolId: '{CognitoConfig.UserPoolId}',
                    userPoolClientId: '{CognitoConfig.UserPoolClientId}',
                    region: '{CognitoConfig.Region}',
                    identityPoolId: '{CognitoConfig.IdentityPoolId}'
                }};
            ");

            await JSRuntime.InvokeAsync<string>("CognitoAuth.initialize", CognitoConfig);
            
            await CheckAuthentication();
            if (isLoggedIn)
            {
                // Set up communication with layout
                Layout?.SetHomePageReference(this);
                await UpdateNavigation();
            }
        }
    }

    private async Task CheckAuthentication()
    {
        try
        {
            var credentialsJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "clypse_credentials");

            if (!string.IsNullOrEmpty(credentialsJson))
            {
                var credentials = System.Text.Json.JsonSerializer.Deserialize<StoredCredentials>(credentialsJson);

                // Check if credentials are still valid
                if (credentials != null && DateTime.Parse(credentials.ExpirationTime) > DateTime.UtcNow)
                {
                    // Restore the Cognito session using the stored IdToken
                    if (!string.IsNullOrEmpty(credentials.IdToken))
                    {
                        try
                        {
                            // Restore AWS credentials using the stored IdToken
                            await JSRuntime.InvokeAsync<object>("CognitoAuth.getAwsCredentials", credentials.IdToken);
                            Console.WriteLine("AWS Cognito session restored successfully");
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Failed to restore Cognito session: {ex.Message}");
                            // Remove invalid credentials
                            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "clypse_credentials");
                            Navigation.NavigateTo("/login");
                            return;
                        }
                    }
                    
                    isLoggedIn = true;
                    StateHasChanged();
                    return;
                }
                else
                {
                    // Credentials expired, remove them
                    await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "clypse_credentials");
                }
            }
        }
        catch (Exception)
        {
            // If any error occurs, assume not logged in
        }

        // Not logged in or credentials expired
        if (!isLoggedIn)
        {
            Navigation.NavigateTo("/login");
        }
    }

    public async Task HandleNavigationAction(string action)
    {
        switch (action)
        {
            case "create-vault":
                currentPage = "create-vault";
                break;
            case "show-vaults":
                currentPage = "vaults";
                break;
            case "delete-vault":
                // TODO: Implement delete vault
                break;
            case "create-credential":
                // TODO: Implement create credential
                break;
            case "delete-credential":
                // TODO: Implement delete credential
                break;
            case "lock-vault":
                await HandleLockVault();
                return; // HandleLockVault already calls StateHasChanged and UpdateNavigation
            case "refresh":
                await HandleRefresh();
                break;
        }

        StateHasChanged();
        await UpdateNavigation();
    }

    private async Task UpdateNavigation()
    {
        var navigationItems = GetNavigationItems();
        Layout?.SetNavigationItems(navigationItems);
        await Task.CompletedTask;
    }

    private List<NavigationItem> GetNavigationItems()
    {
        return currentPage switch
        {
            "vaults" => new List<NavigationItem>
            {
                new() { Text = "Create Vault", Action = "create-vault", Icon = "bi bi-plus-circle" },
                new() { Text = "Delete Vault", Action = "delete-vault", Icon = "bi bi-trash", ButtonClass = "btn-outline-danger" },
                new() { Text = "Refresh", Action = "refresh", Icon = "bi bi-arrow-clockwise" }
            },
            "credentials" => new List<NavigationItem>
            {
                new() { Text = "Create Credential", Action = "create-credential", Icon = "bi bi-plus-circle" },
                new() { Text = "Delete Credential", Action = "delete-credential", Icon = "bi bi-trash", ButtonClass = "btn-outline-danger" },
                new() { Text = "Lock Vault", Action = "lock-vault", Icon = "bi bi-lock", ButtonClass = "btn-outline-secondary" }
            },
            "create-vault" => new List<NavigationItem>
            {
                new() { Text = "Back to Vaults", Action = "show-vaults", Icon = "bi bi-arrow-left" }
            },
            _ => new List<NavigationItem>()
        };
    }

    private async Task HandleRefresh()
    {
        try
        {
            Console.WriteLine("Refreshing vaults...");

            // Create vault manager if not already instantiated
            if (vaultManager == null)
            {
                vaultManager = await CreateVaultManager();
                if (vaultManager == null)
                {
                    Console.WriteLine("Failed to create vault manager");
                    return;
                }
            }

            // Get list of vault IDs
            Console.WriteLine("About to call ListVaultIdsAsync...");
            var vaultIds = await vaultManager.ListVaultIdsAsync(CancellationToken.None);
            Console.WriteLine("ListVaultIdsAsync completed successfully");

            if (vaultIds == null || vaultIds.Count == 0)
            {
                Console.WriteLine("No vaults found");
                await VaultStorage.SaveVaultsAsync(new List<VaultMetadata>());

                // Refresh the vaults component if we're on the vaults page
                if (currentPage == "vaults" && vaultsComponent != null)
                {
                    await vaultsComponent.RefreshVaults();
                }
            }
            else
            {
                Console.WriteLine($"Found {vaultIds.Count} vault(s):");

                // Get existing vaults to preserve any unlocked metadata
                var existingVaults = await VaultStorage.GetVaultsAsync();
                var vaultMetadataList = new List<VaultMetadata>();

                foreach (var vaultId in vaultIds)
                {
                    Console.WriteLine($"  - {vaultId}");

                    // Check if this vault already exists in storage
                    var existingVault = existingVaults.FirstOrDefault(v => v.Id == vaultId);
                    if (existingVault != null)
                    {
                        // Keep existing metadata (name/description if unlocked)
                        vaultMetadataList.Add(existingVault);
                    }
                    else
                    {
                        // Create new vault entry with just the ID
                        vaultMetadataList.Add(new VaultMetadata { Id = vaultId });
                    }
                }

                // Save the updated vault list
                await VaultStorage.SaveVaultsAsync(vaultMetadataList);
                Console.WriteLine("Vault metadata saved to localStorage");

                // Refresh the vaults component if we're on the vaults page
                if (currentPage == "vaults" && vaultsComponent != null)
                {
                    await vaultsComponent.RefreshVaults();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing vaults: {ex.Message}");
        }
    }

    private async Task<IVaultManager?> CreateVaultManager()
    {
        try
        {
            // Get stored credentials from localStorage
            var credentialsJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "clypse_credentials");

            if (string.IsNullOrEmpty(credentialsJson))
            {
                Console.WriteLine("No stored credentials found");
                return null;
            }

            var credentials = System.Text.Json.JsonSerializer.Deserialize<StoredCredentials>(credentialsJson);
            if (credentials?.AwsCredentials == null)
            {
                Console.WriteLine("Invalid stored credentials");
                return null;
            }

            // Create JavaScript S3 invoker
            var jsInvoker = new JavaScriptS3Invoker(JSRuntime);

            // Create vault manager using the factory
            var manager = VaultManagerFactory.CreateForBlazor(
                jsInvoker,
                credentials.AwsCredentials.AccessKeyId,
                credentials.AwsCredentials.SecretAccessKey,
                credentials.AwsCredentials.SessionToken,
                "eu-west-2", // TODO: Get from configuration
                AwsS3Config.BucketName,  
                credentials.AwsCredentials.IdentityId);

            Console.WriteLine("Vault manager created successfully");
            return manager;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating vault manager: {ex.Message}");
            return null;
        }
    }

    private async Task HandleCreateVault(VaultCreationRequest request)
    {
        try
        {
            Console.WriteLine($"Creating vault: {request.Name} - {request.Description}");

            // Create vault manager if not already instantiated
            if (vaultManager == null)
            {
                vaultManager = await CreateVaultManager();
                if (vaultManager == null)
                {
                    Console.WriteLine("Failed to create vault manager");
                    return;
                }
            }

            // Create the vault
            var vault = vaultManager.Create(request.Name, request.Description);
            Console.WriteLine($"Vault created with ID: {vault.Info.Id}");

            // Convert passphrase to SecureString
            var password = new SecureString();
            foreach (var curChar in request.Passphrase)
            {
                password.AppendChar(curChar);
            }

            // Derive encryption key from passphrase
            var key = await CryptoHelpers.DeriveKeyFromPassphraseUsingRfc2898Async(
                password,
                vault.Info.Base64Salt);
            var base64Key = Convert.ToBase64String(key);

            // Save the vault
            Console.WriteLine("Saving vault...");
            var saveResults = await vaultManager.SaveAsync(
                vault,
                base64Key,
                CancellationToken.None);

            Console.WriteLine($"Vault saved successfully. Results: {saveResults}");
            
            // Persist vault metadata immediately since we know the name and description
            var existingVaults = await VaultStorage.GetVaultsAsync();
            var existingVault = existingVaults.FirstOrDefault(v => v.Id == vault.Info.Id);
            
            if (existingVault != null)
            {
                // Update existing vault with the metadata
                existingVault.Name = vault.Info.Name;
                existingVault.Description = vault.Info.Description;
            }
            else
            {
                // Add new vault with full metadata
                existingVaults.Add(new VaultMetadata 
                { 
                    Id = vault.Info.Id,
                    Name = vault.Info.Name,
                    Description = vault.Info.Description
                });
            }
            
            // Save the updated vault list
            await VaultStorage.SaveVaultsAsync(existingVaults);
            Console.WriteLine("Vault metadata persisted to localStorage");
            
            // Navigate back to vaults page
            currentPage = "vaults";
            StateHasChanged();
            await UpdateNavigation();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating vault: {ex.Message}");
            // Don't navigate away on error so user can see the error and try again
        }
    }

    private async Task HandleCancelCreateVault()
    {
        currentPage = "vaults";
        StateHasChanged();
        await UpdateNavigation();
    }

    private async Task HandleVaultUnlocked((VaultMetadata vault, string key) vaultData)
    {
        currentVault = vaultData.vault;
        currentVaultKey = vaultData.key;
        
        // Create vault manager if not already instantiated
        if (vaultManager == null)
        {
            vaultManager = await CreateVaultManager();
            if (vaultManager == null)
            {
                Console.WriteLine("Failed to create vault manager");
                return;
            }
        }
        
        currentPage = "credentials";
        StateHasChanged();
        await UpdateNavigation();
    }

    public async Task HandleLockVault()
    {
        currentVault = null;
        currentVaultKey = null;
        currentPage = "vaults";
        StateHasChanged();
        await UpdateNavigation();
    }


}