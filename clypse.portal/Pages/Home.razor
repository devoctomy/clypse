@page "/"
@page "/home"
@using clypse.portal.Models
@layout HomeLayout
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Clypse Portal - Home</PageTitle>

<h1>Home</h1>
<p>This is the home page.</p>

@code {
    private bool isLoggedIn = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckAuthentication();
        }
    }

    private async Task CheckAuthentication()
    {
        try
        {
            var credentialsJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "clypse_credentials");
            
            if (!string.IsNullOrEmpty(credentialsJson))
            {
                var credentials = System.Text.Json.JsonSerializer.Deserialize<StoredCredentials>(credentialsJson);
                
                // Check if credentials are still valid
                if (credentials != null && DateTime.Parse(credentials.ExpirationTime) > DateTime.UtcNow)
                {
                    isLoggedIn = true;
                    StateHasChanged();
                    return;
                }
                else
                {
                    // Credentials expired, remove them
                    await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "clypse_credentials");
                }
            }
        }
        catch (Exception)
        {
            // If any error occurs, assume not logged in
        }

        // Not logged in or credentials expired
        if (!isLoggedIn)
        {
            Navigation.NavigateTo("/login");
        }
    }


}