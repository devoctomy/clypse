@using clypse.portal.Models
@using clypse.portal.Services
@using clypse.core.Cryptogtaphy
@using clypse.core.Vault
@using System.Security
@inject IVaultStorageService VaultStorage
@inject IVaultManagerFactoryService VaultManagerFactory
@inject IJSRuntime JSRuntime
@inject AwsS3Config AwsS3Config

<div class="vaults-page">
    <h2>Vaults</h2>
    
    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (vaults == null || vaults.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            <h5 class="alert-heading">No Vaults Found</h5>
            <p>No vaults are available. Click the "Refresh" button to search for vaults.</p>
        </div>
    }
    else
    {
        <div class="vaults-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem; margin-top: 1rem;">
            @foreach (var vault in vaults)
            {
                <div class="vault-card" style="background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); position: relative; margin-bottom: 1rem; cursor: pointer;" @onclick="() => ShowPassphrasePanel(vault)">
                    <div class="vault-lock-icon" style="position: absolute; top: 12px; left: 12px; color: #6c757d; font-size: 1rem;">
                        <i class="bi bi-lock-fill"></i>
                    </div>
                    <div class="vault-content" style="margin-left: 1.5rem;">
                        <div class="vault-field">
                            <strong>Id:</strong> @vault.Id
                        </div>
                        <div class="vault-field">
                            <strong>Name:</strong> 
                            @if (string.IsNullOrEmpty(vault.Name))
                            {
                                <span class="text-muted">Unknown, you must unlock this vault first</span>
                            }
                            else
                            {
                                <span>@vault.Name</span>
                            }
                        </div>
                        <div class="vault-field">
                            <strong>Description:</strong> 
                            @if (string.IsNullOrEmpty(vault.Description))
                            {
                                <span class="text-muted">Unknown, you must unlock this vault first</span>
                            }
                            else
                            {
                                <span>@vault.Description</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    
    @* Passphrase Panel *@
    @if (showPassphrasePanel && selectedVault != null)
    {
        <div class="modal" style="display: block; background-color: rgba(0,0,0,0.5);" @onclick="HidePassphrasePanel">
            <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-unlock me-2"></i>
                            Unlock Vault
                        </h5>
                        <button type="button" class="btn-close" @onclick="HidePassphrasePanel"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">
                            <strong>Vault ID:</strong> @selectedVault.Id
                        </p>
                        @if (errorMessage != null)
                        {
                            <div class="alert alert-danger" role="alert">
                                @errorMessage
                            </div>
                        }
                        <div class="mb-3">
                            <label for="passphrase" class="form-label">Passphrase</label>
                            <input type="password" 
                                   class="form-control" 
                                   id="passphrase" 
                                   @bind="passphrase" 
                                   @bind:event="oninput"
                                   @onkeydown="OnPassphraseKeyDown"
                                   placeholder="Enter vault passphrase"
                                   disabled="@isUnlocking" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="HidePassphrasePanel" disabled="@isUnlocking">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="UnlockVault" disabled="@isUnlocking">
                            @if (isUnlocking)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Unlocking...</span>
                            }
                            else
                            {
                                <span>Unlock</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<VaultMetadata> vaults = new();
    private bool isLoading = true;
    private bool showPassphrasePanel = false;
    private bool isUnlocking = false;
    private VaultMetadata? selectedVault = null;
    private string passphrase = string.Empty;
    private string? errorMessage = null;
    private IVaultManager? vaultManager = null;

    [Parameter] public EventCallback<VaultMetadata> OnVaultUnlocked { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadVaults();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadVaults();
        }
    }

    private async Task LoadVaults()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            vaults = await VaultStorage.GetVaultsAsync();
            
            isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading vaults: {ex.Message}");
            isLoading = false;
            StateHasChanged();
        }
    }

    // This method can be called by parent components to refresh the vault list
    public async Task RefreshVaults()
    {
        await LoadVaults();
    }

    private void ShowPassphrasePanel(VaultMetadata vault)
    {
        selectedVault = vault;
        passphrase = string.Empty;
        errorMessage = null;
        showPassphrasePanel = true;
        StateHasChanged();
    }

    private void HidePassphrasePanel()
    {
        showPassphrasePanel = false;
        selectedVault = null;
        passphrase = string.Empty;
        errorMessage = null;
        StateHasChanged();
    }

    private async Task OnPassphraseKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isUnlocking)
        {
            try
            {
                await UnlockVault();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during Enter key unlock: {ex.Message}");
                errorMessage = $"Failed to unlock vault: {ex.Message}";
                StateHasChanged();
            }
        }
    }

    private async Task UnlockVault()
    {
        if (selectedVault == null || string.IsNullOrEmpty(passphrase))
        {
            errorMessage = "Please enter a passphrase";
            StateHasChanged();
            return;
        }

        try
        {
            isUnlocking = true;
            errorMessage = null;
            StateHasChanged();

            if (vaultManager == null)
            {
                vaultManager = await CreateVaultManager();
                if (vaultManager == null)
                {
                    errorMessage = "Failed to create vault manager";
                    isUnlocking = false;
                    StateHasChanged();
                    return;
                }
            }

            var saltBytes = CryptoHelpers.Sha256HashString(selectedVault.Id);
            var base64Salt = Convert.ToBase64String(saltBytes);
            var securePassphrase = new SecureString();
            foreach (char c in passphrase)
            {
                securePassphrase.AppendChar(c);
            }
            var keyBytes = await CryptoHelpers.DeriveKeyFromPassphraseUsingRfc2898Async(
                securePassphrase, 
                base64Salt);
            var base64Key = Convert.ToBase64String(keyBytes);
            var vault = await vaultManager.LoadAsync(selectedVault.Id, base64Key, CancellationToken.None);
            selectedVault.Name = vault.Info.Name;
            selectedVault.Description = vault.Info.Description;
            await VaultStorage.UpdateVaultAsync(selectedVault);

            HidePassphrasePanel();
            await RefreshVaults();
            
            // Notify parent that vault was unlocked
            await OnVaultUnlocked.InvokeAsync(selectedVault);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error unlocking vault: {ex.Message}");
            errorMessage = $"Failed to unlock vault: {ex.Message}";
        }
        finally
        {
            isUnlocking = false;
            StateHasChanged();
        }
    }

    private async Task<IVaultManager?> CreateVaultManager()
    {
        try
        {
            // Get stored credentials from localStorage
            var credentialsJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "clypse_credentials");
            
            if (string.IsNullOrEmpty(credentialsJson))
            {
                Console.WriteLine("No stored credentials found");
                return null;
            }

            var credentials = System.Text.Json.JsonSerializer.Deserialize<StoredCredentials>(credentialsJson);
            if (credentials?.AwsCredentials == null)
            {
                Console.WriteLine("Invalid stored credentials");
                return null;
            }

            // Create JavaScript S3 invoker
            var jsInvoker = new clypse.core.Cloud.Aws.S3.JavaScriptS3Invoker(JSRuntime);

            // Create vault manager using the factory
            var manager = VaultManagerFactory.CreateForBlazor(
                jsInvoker,
                credentials.AwsCredentials.AccessKeyId,
                credentials.AwsCredentials.SecretAccessKey,
                credentials.AwsCredentials.SessionToken,
                "eu-west-2", // TODO: Get from configuration
                AwsS3Config.BucketName,  
                credentials.AwsCredentials.IdentityId);

            Console.WriteLine("Vault manager created successfully");
            return manager;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating vault manager: {ex.Message}");
            return null;
        }
    }
}
